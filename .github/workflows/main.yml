name: Deploy to Server

on:
  push:
    branches:
      - main  # Trigger this on main branch updates

jobs:
  checkout:
    runs-on: self-hosted  # Use a GitHub-hosted runner (could be a self-hosted runner if needed)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up NVM
        run: |
          export NVM_DIR="${{ secrets.NVM_DIR }}"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        shell: bash

      - name: Install dependencies
        run: npm ci  # Install dependencies
        shell: bash

      - name: Run Lint
        run: npm run lint  # Run linting
        shell: bash

      - name: Run Build
        run: npm run build  # Build the project
        shell: bash

  deploy:
    runs-on: self-hosted  # Use a GitHub-hosted runner (could be a self-hosted runner if needed)
    needs: checkout  # Ensure this job runs after the checkout job
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up NVM
        run: |
          export NVM_DIR="${{ secrets.NVM_DIR }}"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        shell: bash

      - name: Deploy to server
        run: |
          echo "Deploying to server..."
          cd ${{ secrets.PROJECT_DIR}}
          git pull
          npm ci
          npm run build
          pm2 restart start-prod-storage
        shell: bash

      - name: Tag Deployment
        run: |
          git tag -a "deploy-$(date +'%Y%m%d%H%M%S')" -m "Deployment to server"
          git push origin --tags

